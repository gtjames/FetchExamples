<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Cache</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/@docsearch/css@3'>
    <link  href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script>
    <style>
        table, tr, td, th { border: 1px solid black; border-collapse: collapse; padding: 4px 18px;}
        td.left     { width: 50%;}
        td.right    { width: 50%;}
        tr.current > td:first-child {  
            background-image: url('images/rtArrow.png'); 
            background-size: 20px 20px; 
            background-repeat: no-repeat; 
            background-position: center right;
            padding-left: 40px;
        }
        td.tag      { background-color: lightgreen;    font-family: 'Courier New'; }
        td.index    { background-color: paleturquoise; font-family: 'Courier New'; }
        td.offset   { background-color: lemonchiffon;  font-family: 'Courier New'; }
        td.Hit      { background-color: greenyellow}
        tr.current  { background-color: aquamarine; }
        tr.next     { background-color: gold; }
        .Miss       { background-color: lightcoral; }
        .found      { background-color: lightskyblue; border-radius: 10%; }
        .top        { vertical-align:top; }
        input[type=text]         { width: 60px; }
        .scrolling  { overflow-y: scroll; height:560px; }

        .modal      {--bs-modal-width:  575px;}

        .dropdown-check-list {
  display: inline-block;
}

.dropdown-check-list .anchor {
  position: relative;
  cursor: pointer;
  display: inline-block;
  padding: 5px 50px 5px 10px;
  border: 1px solid #ccc;
}

.dropdown-check-list .anchor:after {
  position: absolute;
  content: '';
  border-left: 2px solid black;
  border-top: 2px solid black;
  padding: 5px;
  right: 10px;
  top: 20%;
  -moz-transform: rotate(-135deg);
  -ms-transform: rotate(-135deg);
  -o-transform: rotate(-135deg);
  -webkit-transform: rotate(-135deg);
  transform: rotate(-135deg);
}

.dropdown-check-list .anchor:active:after {
  right: 8px;
  top: 21%;
}

.dropdown-check-list ul.items {
  padding: 2px;
  display: none;
  margin: 0;
  border: 1px solid #ccc;
  border-top: none;
}

.dropdown-check-list ul.items li {
  list-style: none;
}

.dropdown-check-list.visible .anchor {
  color: #0094ff;
}

.dropdown-check-list.visible .items {
  display: block;
}
    </style>
</head>
<body>
    <label for='tagBits'  ># of Tag Bits</label>   <input id='tagBits'     type='text'>
    <label for='indexBits'># of Index Bits</label> <input id='indexBits'   type='text'>
    <label for='fetchCnt' ># of Fetches</label>    <input id='fetchCnt'    type='text'>
    <input type='radio' name='source' />           <label for='binary'>    Binary</label>
    <input type='radio' name='source' checked />   <label for='basketball'>Basketball</label>
    <button id='reset'  class='btn btn-success'  >Reset</button>
    <div id='teamsList' class='dropdown-check-list' tabindex='100'>
        <span class='anchor'>Exclude Teams</span>
        <ul id='teams' class='items'></ul>
    </div>
    <label for='studentID' >Last 4 of ID</label>    <input id='studentID'    type='text'>
    <table>
        <tr><td>Cache Data Bits per Block</td><td id='bitsPerBlock'></td><td>Bits per Offset</td><td id='bitsPerOffset'></td></tr>
        <tr><td>Total Bits</td><td id='totalBits'></td><td>Overhead</td><td id='overhead'></td></tr>
    </table>
    <hr>
    <table>
        <tr>
        <td class='left top'>
                <label for='PC'>Program Counter</label> <input id='PC' type='text'>
                <button id='step' class='btn btn-warning'>Step</button>
                <button id='clear' class='btn btn-success'>Clear</button>
                <button id='showMemory' class='btn btn-primary' data-bs-toggle='modal' data-bs-target='#mainMemory' type='button' onclick=showMainMemory()>Show Main Memory</button>
                <input type='checkbox' id='adrsOnly' name='scales' checked/> <label for='adrsOnly'>Address Only</label>
                <div class='scrolling'>
                    <table class='sortable copyable'>
                    <thead><tr> <td>
                        <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-copy' viewBox='0 0 16 16'>
                            <path fill-rule='evenodd' d='M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z'/>
                        </svg>
                        Tag</td> <th>Index</th> <th>Address/Value</th> <th>State</th> </tr></thead>
                    <tbody id='cache'></tbody>
                </table>
            </div>
        </td>
        <td class='right top'>
            <div class='scrolling'>
                <table class='sortable copyable'>
                    <thead>
                        <tr> <td>
                            <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-copy' viewBox='0 0 16 16'>
                                <path fill-rule='evenodd' d='M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z'/>
                            </svg>
                      PC</td> <th id='sortTag'>Tag</th> <th id='sortIndex'>Index</th> <th>Address/Value</th> <th>Value</th> </tr></thead>
                    <tbody id='mem'></tbody>
                </table>
            </div>
        </td>
        </tr>
    </table>
    <div class='modal' id='mainMemory' tabindex='1'>
      <div class='modal-dialog modal-dialog-scrollable'>
          <div class='modal-content bg-info-subtle'>
              <div class='modal-header bg-info-subtle'>
              <h1 class='modal-title fs-5' id='modalTitle'>Contents of Application Memory</h1>
              <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
          </div>
          <div class='modal-body bg-secondary-subtle pt-0'>
            <table class='table sortable copyable table-hover table-striped'>
              <thead class='table-secondary'>
                <tr><td>
                    <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-copy' viewBox='0 0 16 16'>
                        <path fill-rule='evenodd' d='M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z'/>
                    </svg>
                Tag</td><th>Index</th><th>Contents</th></tr></thead>
              <tbody id='memoryBlocks'></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
</body>
<script src='basketball.js'></script>
<script src='js/sortColumns.js'></script>
<script>
    let     bodyCache   = document.getElementById('cache');
    let     body        = document.getElementById('mem');
    let     pc          = document.getElementById('PC');
    let     studentID   = document.getElementById('studentID');
    let     max         = Math.pow(2,32);
    let     basketball  = getList();
    let     seed        = -1;

    let     fetch, cache, mainMemory, mainMemoryA;
    let     step, cacheBlk;
    let     instCnt;
    let     numBlocks;
    let     binary = false;
    let     tagBits = 2;
    let     indexBits = 3;
    let     checkList = document.getElementById('teamsList');
    let     teamSet = getTeams();
    let     set = document.getElementById('teams')

    document.getElementById('tagBits').value   = tagBits;
    document.getElementById('indexBits').value = indexBits;
    document.getElementById('fetchCnt').value  = 40;
 
    for (let t of teamSet) {
        set.innerHTML += `<li><input type='checkbox' value='${t}' />${t}</li>`;
        // set.innerHTML += `<li><input type='checkbox' value='${t}' ${set.innerHTML.length > 0 ?'checked':''} />${t}</li>`;
    }

    checkList.getElementsByClassName('anchor')[0].onclick = function(evt) {
    if (checkList.classList.contains('visible'))
        checkList.classList.remove('visible');
    else
        checkList.classList.add('visible');
    }
    reset();
    rebuildMainMemory();

    document.getElementById('step').addEventListener('click', nextStep);
    document.getElementById('reset').addEventListener('click', reset);
    document.getElementById('clear').addEventListener('click', clearCache);
    document.getElementById('sortTag').addEventListener('click', sortTag);
    document.getElementById('sortIndex').addEventListener('click', sortIndex);

function sortTag(e) {
    let dir = (e.target.classList == 'ATOZ') ? 1 : -1
    fetch.sort((a, b) => a.tag.localeCompare(b.tag) * dir);
    createInstructionTable();
}

function sortIndex(e) {
    let dir = (e.target.classList == 'ATOZ') ? 1 : -1
    fetch.sort((a, b) => (+a.index - +b.index) * dir);
    createInstructionTable();
}

function rebuildMainMemory() {
    mainMemory  = {};
    mainMemoryA = {};
    let len = 0
    if (binary) {
        for (let b of fetch) {
            if ( ! mainMemory[b.tag+' '+b.index])       mainMemory[b.tag +' '+b.index] = [];
            let value = `<span id=${(b.index + b.value).replaceAll(' ','-')}>${b.value}</span>`;
            mainMemory[b.tag+' '+b.index].push(value);
        }
    } else {
        for (let b of basketball) {
            let index = (+b.index+1024).toString(2).substr(11-indexBits);

            if ( ! mainMemory[b.tag+' '+index])         mainMemory[b.tag +' '+index] = [];
            let value = `<span id=${(index + b.value).replaceAll(' ','-')}>${b.index} ${b.value}</span>`;
            mainMemory[b.tag+' '+index].push(value);
            if ( ! mainMemoryA[b.tag+' '+index])         mainMemoryA[b.tag +' '+index] = [];
            value = `<span id=${(index + b.value).replaceAll(' ','-')}>${b.index}</span>`;
            mainMemoryA[b.tag+' '+index].push(value);
        }
    }
}

function showCacheData() { 
    let     bitsPerBlock;

    tagBits   = +document.getElementById('tagBits').value;
    indexBits = +document.getElementById('indexBits').value;

    bitsPerBlock = Math.pow(2, 32 - indexBits - tagBits) * 8;
    document.getElementById('bitsPerBlock').innerText = bitsPerBlock;
    document.getElementById('bitsPerOffset').innerText = 32 - tagBits - indexBits;
    document.getElementById('totalBits').innerText    = tagBits + bitsPerBlock + 1;
    document.getElementById('overhead').innerText     = (((tagBits + 1)/bitsPerBlock)*100).toFixed(2) + ' %';
}

function clearCache() {
    let pcRow;
    cache = [];
    bodyCache.innerHTML = '';
    for (let i = 0; i < numBlocks; i++) {
        let index = '0000000000000000'+Number(i).toString(2);
        index = index.substr(index.length-indexBits, indexBits);
        cache.push({blockNum: `${i}`, index:`${index}`, tag:'', value:'', hit:''});

        let inner = `<tr id=cache-${i}><td class='tag' id=${index}.tag></td><td class='index' id=${index}.index>${index}</td><td id=${index}.value></td><td id=${index}.hit></td></tr>`;
        bodyCache.innerHTML += inner;
    }

    if (step >= 0 && step < instCnt) { 
        pcRow = document.getElementById('tr-'+(step+1));
        pcRow.classList.remove('next');

        pcRow = document.getElementById('tr-'+step);
        pcRow.classList.remove('current');
    }
    for (let f = 0; f < fetch.length; f++) {
        pcRow = document.getElementById('tr-'+f);
        pcRow.className = '';
    }
    pc.value    = 0;
    step        = 0;
    pcRow = document.getElementById('tr-0');
    pcRow.scrollIntoView({ behavior: 'auto', block: 'start', inline: 'start' });
}

function reset() {
    fetch       = [ ];
    cache       = [ ];
    step        = -1;
    cacheBlk    = -1;
    pc.value    = 0;

    seed = (studentID.value.length != 0) ? +studentID.value : -1;

    showCacheData();
    binary      = document.getElementsByName('source')[0].checked;
    tagBits     = +document.getElementById('tagBits').value;
    indexBits   = +document.getElementById('indexBits').value;
    instCnt     = +document.getElementById('fetchCnt').value;
    
    numBlocks   = Math.pow(2, indexBits);

    //  randomly create the addresses with their tag and index bits
    if (binary) {
        for (let i = 0; i < instCnt; i++) {
            let adrs = '00000000000000000000000000000000'+getRandom(max).toString(2);
            adrs = adrs.substr(adrs.length-32);
            let tag   = adrs.substr(0, tagBits);
            let index = adrs.substr(tagBits, indexBits);
            let value = adrs.substr(tagBits + indexBits);
            let b     = basketball[getRandom(basketball.length)];
            adrs      = `<span class='offset'>${value}</span>`;         //  <span class='tag'>&ensp;${tag}&ensp;</span><span class='index'>&ensp;${index}&ensp;</span>
            fetch.push({pc: `${i}`, tag: `${tag}`, index: `${index}`, adrs: `${adrs}`, value:`${b.value}` });
        }
    } else {
        let teams = document.querySelectorAll('input[type=checkbox]:checked');
        teams = Array.from(teams);
        teams = teams.map(t => t.value);
        basketball  = getList(teams);

        for (let i = 0; i < instCnt; i++) {
            let b     = basketball[getRandom(basketball.length)];    
            let tag   = b.tag;
            let index = (+b.index+1024).toString(2).substr(11-indexBits);
            let adrs  = b.index;
            let value = b.value;
            fetch.push({pc: `${i}`, tag: `${tag}`, index: `${index}`, adrs: `${adrs}`, value:`${value}` });
        }
    }
    createInstructionTable();
    clearCache();
    rebuildMainMemory();
}

function createInstructionTable() {
    //  create the table for memory addresses to fetch
    body.innerHTML = '';
    for (let i = 0; i < fetch.length; i++) {
        let inner = `<tr id=tr-${i}><td>${i}</td> <td class='tag'     >${fetch[i].tag}</td> <td class='index'   >${fetch[i].index}</td> <td class='offset'  >${fetch[i].adrs}</td> <td>${fetch[i].value}</td></tr>`;
        body.innerHTML += inner;
    }
}

function nextStep() {
    let pcRow;
    if (step >= 0) {
        pcRow = document.getElementById('tr-'+(step+1));
        if(pcRow) pcRow.classList.remove('next');

        pcRow = document.getElementById('tr-'+step);
        pcRow.classList.remove('current');
        pcRow.scrollIntoView({ behavior: 'auto', block: 'start', inline: 'start' });
    }
    step = +pc.value;
    pc.value = step + 1;

    if (cacheBlk >= 0) {
        cacheRow = document.getElementById('cache-'+cacheBlk);
        cacheRow.classList.remove('current');
    }

    pcRow = document.getElementById('tr-'+step);
    pcRow.classList.add('current');
    pcRow = document.getElementById('tr-'+(step+1));
    if (pcRow) pcRow.classList.add('next');

    let block = cache.filter(c => c.index === fetch[step].index)[0];
    cacheBlk = block.blockNum;

    cacheRow = document.getElementById(block.index+'.tag');
    cacheRow.classList.remove('Hit');
    cacheRow = document.getElementById('cache-'+cacheBlk);
    cacheRow.classList.remove('next');
    cacheRow.classList.add('current');

    if (block.tag === fetch[step].tag) {
        block.hit = 'Hit';
        document.getElementById('tr-'+step).classList.add(block.hit);
    } else {
        document.getElementById(fetch[step].index+'.tag').innerText = fetch[step].tag;
        block.tag = fetch[step].tag;
        block.hit = 'Miss';
    }

    let value = document.getElementById(fetch[step].index+'.value');
    let adrsOnly = document.getElementById('adrsOnly').checked;
    if (block.hit == 'Miss')
        if (adrsOnly && ! binary)
            value.innerHTML = mainMemoryA[fetch[step].tag+' '+fetch[step].index].join(',');
        else
            value.innerHTML = mainMemory[fetch[step].tag+' '+fetch[step].index].join(',');
    
    block.value = fetch[step].value;
    document.getElementById((fetch[step].index+fetch[step].value).replaceAll(' ','-')).className = 'found';

    document.getElementById(fetch[step].index+'.hit').innerText = block.hit + ' ' + step;
    document.getElementById(fetch[step].index+'.hit').className = block.hit;

    if (step+1 < instCnt) {
        let nextCacheRow = cache.filter( c => c.index === fetch[step+1].index)[0];
        cacheRow = document.getElementById('cache-'+nextCacheRow.blockNum);
        cacheRow.classList.add('next');
        if (nextCacheRow.tag === fetch[step+1].tag) {
            cacheRow = document.getElementById(nextCacheRow.index+'.tag');
            cacheRow.classList.add('Hit');
        }
    }
}

//      Does double duty for webcams and alerts
function showMainMemory() {
  let memoryBlocks = document.getElementById('memoryBlocks');
  
  memoryBlocks.innerHTML = '';

  for ( let key in mainMemory) {
    let tag1, tag2, index;
    let start = '0'.repeat(32-tagBits-indexBits);
    let end   = '1'.repeat(32-tagBits-indexBits);
    tag2 = '';
    if(binary)
      [tag1, index] = key.split(' ');
    else
      [tag1, tag2, index] = key.split(' ');
      memoryBlocks.innerHTML += `<tr id=${key}><td class='tag'>${tag1 + ' ' + tag2}</td><td class='index'>${index}</td><td class='offset'>${mainMemory[key]}</td></tr>`;
      //  <td> <table><tr><td>${start}</td></tr><tr><td class='offset'>${mainMemory[key]}</td></tr><tr><td>${end}</td>   </tr></table> </td></tr>`;          
  }
}

function getRandom(max) {
    if (seed === -1)
        return Math.floor(Math.random() * max);
    else
        return getNextRandom(seed, max);
}

function getNextRandom(newSeed, max) {
    seed = Math.abs(Math.floor(Math.sin(seed) * max));
    return seed;
}
</script>
</html>
