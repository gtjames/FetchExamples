<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Word</title>
    <style>
        .e {background-color: green;}
        .c {background-color: palegoldenrod;}
        ._ {background-color: gray;}
        td {
            font-size: 40px;
            padding: 5px 5px;
            font-family: "Courier New",serif
        }
    </style>

    <style>
        body {
            background-color: lightcyan;
        }

        #keyboard {
            margin: 0 8px;
            user-select: none;
        }

        .row {
            display: flex;
            width: 90%;
            margin: 0 auto 8px;
            /* https://stackoverflow.com/questions/46167604/ios-html-disable-double-tap-to-zoom */
            /*touch-action: manipulation;*/
        }

        button {
            font-size: 35px;
            font-family: inherit;
            font-weight: bold;
            border: 0;
            padding: 0;
            margin: 0 6px 0 0;
            height: 58px;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-transform: uppercase;
        }

        .oneLetter {
            width: 2em;
            height: 20px;
            font-size: .5em;
        }
        .half {flex: 0.5;}

        .one-and-a-half {
            flex: 1.5;
            font-size: 12px;
        }
    </style>
</head>
<body>
<table>
    <tr>
        <td><label for="guess">Take a Guess</label></td>
        <td><input id="guess"></td>
    </tr>
    <tr>
        <td><button id="search">Search</button></td>
    </tr>
</table>
<table id="result">

</table>
<h3 id="foundYou"></h3>
<table>
    <tr>
        <td><input id="0" class="oneLetter" type="text"></td>
        <td><input id="1" class="oneLetter" type="text"></td>
        <td><input id="2" class="oneLetter" type="text"></td>
        <td><input id="3" class="oneLetter" type="text"></td>
        <td><input id="4" class="oneLetter" type="text"></td>
    </tr>
    <tr>
        <td colspan="5">
            <button id="eliminate">Search</button>
        </td>
    </tr>
</table>

<p id="error"></p>
<div id="keyboard">
    <div class="row"><button data-key="q">q</button><button data-key="w">w</button><button data-key="e">e</button><button data-key="r">r</button><button data-key="t">t</button><button data-key="y">y</button><button data-key="u">u</button><button data-key="i">i</button><button data-key="o">o</button><button data-key="p">p</button></div>
    <div class="row"><div class="spacer half"></div><button data-key="a">a</button><button data-key="s">s</button><button data-key="d">d</button><button data-key="f">f</button><button data-key="g">g</button><button data-key="h">h</button><button data-key="j">j</button><button data-key="k">k</button><button data-key="l">l</button><div class="spacer half"></div></div>
    <div class="row"><div class="one-and-a-half"></div><button data-key="z">z</button><button data-key="x">x</button><button data-key="c">c</button><button data-key="v">v</button><button data-key="b">b</button><button data-key="n">n</button><button data-key="m">m</button><div class="one-and-a-half"></div></div>
</div>
<ul id="tryThis"></ul>
</body>
<script>
	let fiveLetters, hiddenWord, unused = [], lock = [], close = [];
	let match = ['_','_','_','_','_'];
	lock = ['_','_','_','_','_'];

	let result = document.getElementById('result');
	let guess = document.getElementById('guess');
	let foundYou = document.getElementById('foundYou');
	let error = document.getElementById('error');
	let tryThis = document.getElementById('tryThis');

	window.addEventListener("load", function () {
		// document.body.style.backgroundColor = getColorCode();

		fetch('https://raw.githubusercontent.com/gtjames/csv/master/Dictionaries/five.txt')
			.then(resp => resp.text())
			.then(words => setup(words) )
	});

	document.getElementById('search').addEventListener('click', search);
	document.getElementById('eliminate').addEventListener('click', eliminate);

	function eliminate() {
		let letter, attempt = '';
		for (let i = 0; i < 5; i++) {
			letter = document.getElementById(i+"").value;
			if ( letter >= 'A' && letter <= 'Z') {
				lock[i] = letter.toLowerCase();
				match[i] = 'e';
				setActive(letter.toLowerCase(), 'e');
				attempt += letter;
			}
			if ( letter >= 'a' && letter <= 'z')    {
				close.push(letter);
				if (match[i] !== 'c') match[i] = 'c';
				attempt += letter;
				setActive(letter, match[i]);
			}
			if (letter[0] === '!') {
				attempt += letter.charAt(1);
				setActive(letter.charAt(1), '_');
				unused.push(letter.charAt(1));
			}
		}
		findPossibles(attempt.toLowerCase(), unused, lock, match);

		let td ='';
		for (let h = 0; h < 5; h++) {
			td += `<td class="${match[h]}">${attempt[h]}</td>`
		}
		create(match, attempt);
		result.innerHTML += `<tr>${td}</tr>`;

	}

	function create(match, attempt) {
		let move = '';
		for(let i = 0; i < 5; i++) {
			move += match[i] + attempt[i];
        }
		fetch("https://3stehybb7a.execute-api.us-east-2.amazonaws.com/prod", {
			method: 'POST',
			body: JSON.stringify({ move: move })
		})
			// .then(() => getQuoteList())
			.catch(err => console.log('Fetch Error :', err) );
	}

	function setup(words) {
		fiveLetters = words.split('\n');
		hiddenWord = select();
		foundYou.innerHTML = `${hiddenWord}<br>`;
    }

	function select() {
		let index = Math.floor(Math.random() * fiveLetters.length);
		return fiveLetters[index];
	}

	function search() {
		let attempt = guess.value;
		let match = ['_','_','_','_','_'];

		error.innerText = '';
		if ( fiveLetters.find(w => w === attempt) !== attempt) {
			error.innerText = `${attempt}: is not a valid word`;
			return;
        }

		for (let g = 0; g < 5; g++) {
			let found = false;
			for (let h = 0; h < 5; h++) {
				if (hiddenWord[h] === attempt[g]) {
					found = true;
					if (match[g] === 'e') break;
					match[g] = (h === g) ? 'e' : 'c';
					setActive(attempt[g], match[g]);
					if (match[g] === 'e') lock[g] = attempt[g];
					if (match[g] === 'c') close.push(attempt[g]);
				}
			}
			if (!found) {
				setActive(attempt[g], '_');
				unused.push(attempt[g]);
			}
		}

		findPossibles(attempt, unused, lock, match);

		let td ='';
		for (let h = 0; h < 5; h++) {
			td += `<td class="${match[h]}">${attempt[h]}</td>`
		}
		result.innerHTML += `<tr>${td}</tr>`;
		// document.body.style.backgroundColor = getColorCode();
	}

	function findPossibles(attempt, unused, lock, match) {

		let possibles = fiveLetters;
		//  eliminate all words that contain an unused letter
		possibles = possibles.filter(w => {
			for (let un of unused) {
				if (w.indexOf(un) >= 0)
					return false;           //  contains an unused letter
			}
			return true;                    //  free of all unused letters
		});

		//  find the words that match position and letter
		possibles = possibles.filter(w => {
			for (let i = 0; i < 5; i++) {
				if ((match[i] === 'e' && lock[i] !== w.charAt(i)))
					return false;           //  this word doesn't have a matching letter in a required position
			}
			return true;                    //  all required letters are accounted for
		});

        //  find words that have all of the possible letters
		possibles = possibles.filter(w => {
            for (let c of close) {
                if (w.indexOf(c) === -1)
					return false;           //  does not contain a close letter
            }
			return true;                    //  contains all close letters
		});

		let text = '';
		for (let w of possibles) {
			text += `<li>${w}</li>`;
        }
		tryThis.innerHTML = text;
		foundYou.innerHTML += `Possibles ${possibles.length}<br>`;
	}

	function getColorCode() {
		let makeColorCode = '0123456789ABCDEF';
		let code = '#';
		for (let count = 0; count < 6; count++) {
			code =code+ makeColorCode[Math.floor(Math.random() * 16)];
		}
		return code;
	}

	function setActive(letter, status) {
		// use querySelectorAll to get all of the type li elements
		const allTypes = document.querySelectorAll("div.row > button");
		allTypes.forEach((item) => {
			// check to see if this is the one to make active
			if (item.dataset.key === letter) {
				item.classList.add(status);
			}
		});
	}

</script>
</html>