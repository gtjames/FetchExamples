<!DOCTYPE html>
<html lang="en">

<head>
    <title>Disney</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-indigo.css" id="css" >
    <link rel="stylesheet" href="styles/styles.css">
</head>
<body>

<div class="w3-container w3-theme-l1">
    <div id="menu" class="w3-bar"></div>
</div>

<div class="w3-container w3-theme w3-padding-16">
	<h5>Results will be displayed twice. Using &lt;template&gt; and not</template></h5>
    <label for="characterSearch">Search for a Character</label>
    <input type="text" id="characterSearch" value="Princess">
    <button id="search">Search</button>
</div>

<div class="w3-row w3-theme-l3 w3-center">
    <section id="card1"></section>
</div>
<div class="w3-row w3-theme-l3 w3-center">
    <section id="card2"></section>
</div>
<template id="cardTemplate">
    <div id="div" class="w3-col m4 l3 disney-card">
        <a id="a" href="">character.name</a>
        <br>
        <img id="img" src="" alt="">
        <ul id="ul" class='' id="movies">
        </ul>    </div>
</template>

</body>
<script>
	let card1 = document.getElementById('card1');
	let card2 = document.getElementById('card2');
	let search = document.getElementById('search');

	search.addEventListener('click', searchCharacter);
	let allCharacters = [];
	if (localStorage.getItem('disneyCharacters') !== null) {
		allCharacters = JSON.parse(localStorage.getItem('disneyCharacters'));
		card1.innerHTML = `Found ${allCharacters.length} Characters in LS`;
	} else {
		for (let i = 1; i <= 149; i++) {
			getAllCharacters(i);
		}
	}

	function searchCharacter() {
		localStorage.setItem('disneyCharacters', JSON.stringify(allCharacters));
		let name = document.getElementById('characterSearch');
		if ( name.value.length < 3) {
			card1.innerHTML = `Name must be 3 or more characters`;
			return;
		}
		card1.innerHTML = card2.innerHTML = '';
		let matching = allCharacters.filter(c => c.name.toUpperCase().indexOf(name.value.toUpperCase()) >= 0);
		if ( matching.length === 0 )            return;
		name.value = matching[0].name;
		let row = 0;
		for (let character of matching) {
			row = ((row+1)%5)+1;
			let li = "";
			for (let films of character.films) {
				li += `<li>${films}</li>`;
			}

			if ( typeof character.imageUrl === 'undefined')
				character.imageUrl = " /rev";
			card1.innerHTML += `
                <div class="w3-col m4 l3 disney-card w3-theme-d${row}">
                    <a href="${character.url}">${character.name}</a>
                    <br>
                    <img src="${character.imageUrl}" alt="">
                    <ul class='w3-theme-l${row}' id="movies">
                        ${li}
                    </ul>
                </div>`;
			card2.appendChild(createCard(character, li, row));
		}
	}
	function createCard(character, li, row) {
		const node = cardTemplate.content.cloneNode(true);
		const div    = node.querySelector('#div')
		const link   = node.querySelector('#a')
		const img    = node.querySelector('#img')
		const ul     = node.querySelector('#ul')

		div.className += ` w3-theme-d${row}`;

		link.href = character.url;
		link.innerHTML = character.name;

		img.src = character.imageUrl;

		ul.innerHTML = li;
		ul.className = `w3-theme-l${row}`;

		return node;
	}


	function getAllCharacters(page) {
		let url = `https://api.disneyapi.dev/characters?page=${page}`;
		fetch(url)
			.then(resp => resp.json())          //  wait for the response and convert it to JSON
			.then(character => {                    //  with the resulting JSON data do something
				allCharacters = allCharacters.concat(character.data);
				character.data.forEach(one =>  card1.innerHTML = `Loading Characters: ${allCharacters.length} so far ${one.name}`);
			});
	}

</script>
<script src="js/menu.js"></script>
<script>makeMeActive('Disney')</script>
</html>