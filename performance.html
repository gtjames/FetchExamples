<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Performance</title>
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/@docsearch/css@3'>
  <link  href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
  <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script>

  <style>
    table, td, th {
      border-width: 1px;
      border-style:solid;
      border-collapse: collapse;
      margin: 3px;
      padding: 3px;
    }
    td, th      { text-align: center; }
    table      {margin: 10px;}
    .given  { background-color: lightblue;}
    .solve  { background-color: cornflowerblue;}
    .key    { background-color: lightskyblue; }
    .instr  { background-color: lightcyan; }
    .lenErr { border-color: blueviolet; border-width: 4px; }
    .error  { border-color: red;        border-width: 4px;}

    td { background-color: lightgrey;}
    input       { background-color: lightgoldenrodyellow; margin: 2px; padding: 2px; text-align: right;}
    input.small { width: 100px; }
    input.medium{ width: 140px; }
    input.big   { width: 240px; }
    th.C1       { width: 14%; }
    th.C2       { width: 10%; }
    th.C3       { width: 16%; }

  </style>
</head>
<body>
  <table style="width: 98%; table-layout: fixed;">
    <thead>
      <tr>
        <th class='C1 given'>Instruction Type</th>
        <th class='C3 given'># of Instructions</th>
        <th class='C2 given'>Instruction CPI</th>
        <th class='C1 solve'># of Cycles</th>
        <th class='C2 solve'>Pct of Inst Types</th>
        <th class='C2 solve'>CPI by Type</th>
      </tr>
    </thead>
  <tbody id='Instruction'>
    </tbody>
    <tfoot>
      <tr>
        <td class='key'>Totals</td>
        <td id='TotalInstructions' class='given'></td>
        <td id='TotalCPI'></td>
        <td>
          <input id='TotalCycles' class="medium">
          <input id='TotalCyclesA' type='hidden'>  
        </td>
        <td class='key'>Weighted CPI</td>
        <td>
          <input id='WeightedCPI' class="small">
          <input id='WeightedCPIA' type='hidden'>  
        </td>
      </tr>
      <tr>
        <td class='key'>Cycles / Sec (GHz)</td>
        <td>
          <input id='cps' class="medium">
          <input id='cpsA' type='hidden'>  
        </td>
        <td class='key'>CPU Time</td>
        <td id='runTime'></td>
      </tr>
      <tr>
        <td class='key'>Sec / Cycles (ns)</td>
        <td>
          <input id='spc' class='medium'>
          <input id='spcA' type='hidden'>  
        </td>
        <td>
            <button id='reset'  class='btn btn-primary'  >Reset </button>
            <input type='checkbox' id='revealOn' checked/>
        </td>
        <td><button id='submit' class='btn btn-success'  >Submit</button></td>
      </tr>
      <tr>
        <td>FP</td>
        <td>
          <input id='dec' class='medium'>
        </td>
        <td>
          <input id='fp' class='medium'>
          <input id='fpA' type='hidden'>  
        </td>
        <td><button id='reveal' class='btn btn-danger'  >Reveal</button></td>
      </tr>
      <tr>
        <th class="solve">Exponent</th>
        <th class="solve">Significant</th>
        <th class="solve">FP Binary (32 bits)</th>
        <th class="solve">Hexadecimal</th>
      </tr>
      <tr>
        <td>
          <input id='expDec' class='small'>
          <input id='exp' class='small'>
          <input id='expA' type='hidden'>  
        </td>
        <td>
          <input id='frac' class='medium'>
          <input id='fracA' type='hidden'>  
        </td>
        <td class='big'>
          <input id='binary' class='big'>
          <input id='binaryA' type='hidden'>  
        </td>
        <td>
          <input id='hex' class='small'>
          <input id='hexA' type='hidden'>  
        </td>
      </tr>
      </tfoot>
  </table>
</body>
<script>
  let totCycles   = document.getElementById('TotalCycles');
  let totCyclesA  = document.getElementById('TotalCyclesA');
  let totInst     = document.getElementById('TotalInstructions');

  let totCPI      = document.getElementById('TotalCPI');
  let wtdCPI      = document.getElementById('WeightedCPI');
  let wtdCPIA     = document.getElementById('WeightedCPIA');
  let runTime     = document.getElementById(`runTime`);
  let instr       = document.getElementById('Instruction');
  let cps         = document.getElementById(`cps`);
  let cpsA        = document.getElementById(`cpsA`);
  let spc         = document.getElementById(`spc`);
  let spcA        = document.getElementById(`spcA`);

  let dec     = document.getElementById('dec'  );
  let decA    = document.getElementById('decA' );
  let fp      = document.getElementById('fp'   );
  let fpA     = document.getElementById('fpA'  );
  let frac    = document.getElementById('frac' );
  let fracA   = document.getElementById('fracA');
  let exp     = document.getElementById('exp'  );
  let expDec  = document.getElementById('expDec');
  let expA    = document.getElementById('expA' );
  let binary  = document.getElementById('binary' );
  let binaryA = document.getElementById('binaryA');
  let hex     = document.getElementById('hex' );
  let hexA    = document.getElementById('hexA');
  let revealOn= document.getElementById('revealOn');

  document.getElementById(`reset`).addEventListener('click', reset);
  document.getElementById(`submit`).addEventListener('click', submit);
  document.getElementById(`reveal`).addEventListener('click', reveal);

  let types =['Add', 'Multiply', 'Branch', 'Floating Pt'];
  let totalInstructions;
  let totalCycles;
  let typeCPI;
  let numInstructions;
  let numCycles;
  let remainingPct;
  let WeightedCPI;
  let CPUTime;

  reset();

  function reveal () {
    let inputs = document.querySelectorAll('input[type="hidden"]');
    inputs.forEach(i => {
      document.getElementById(i.id.substring(0,i.id.length-1)).value = i.value;
    });
    totCPI.innerText    = totalCycles / totalInstructions;
  }

function submit() {
  for (let i = 0; i < 4; i++) {
    close(`NumCycles${i}`,  true, 0, true);
    close(`pctCycles${i}`,  true, 0, true);
    close(`PartialCPI${i}`, true, 0, true);
  }
  close('TotalCycles', true, 0, true);
  close('WeightedCPI',    true, 0, true);
  close('cps',    false, 0.05, true);
  close('spc',    false, 0.05, true);
  close('fp',     true,  0, true);
  close('exp',    true,  0, true);
  close('frac',   true,  0, true);
  close('hex',    true,  0, false);
  close('binary', true,  0, false);
}

function close(el, exact, pct, isNum) {
  let res, lenError = false;

  let input = document.getElementById(el);
  if (input === null) return true;
  input.classList.remove('error');
  input.classList.remove('lenErr');

  let value  = input.value;
  let valueA = document.getElementById(el+'A').value;

  if (el === 'hex') {
    lenError = value.length != 8;
    value = value + '0'.repeat(8  - value.length);
  }
  if (el === 'binary') {
    lenError = value.length != 32;
    value = value + '0'.repeat(32 - value.length);
  }
  value  = value.replaceAll(' ','').replaceAll(',','');
  valueA = valueA.replaceAll(' ','').replaceAll(',','');
  if (isNum) {
    value  = +value;
    valueA = +valueA;
  }

  if ( exact ) {
    res = value === valueA
  }
  else {
    res = Math.abs( (value - valueA) / valueA) < pct
  }
  if (lenError) input.classList.add('lenErr');
  if (!res)     input.classList.add('error');

  return res;
}

function reset() {
    totalInstructions;
    totalCycles = 0;
    WeightedCPI = 0;
    remainingPct = 100;
    typeCPI = [];
    numInstructions = [];
    numCycles = [];
    pctOfCycles = [];
    CPUTime = ((Math.random() / 1000)+0.0002).toFixed(6);
    instr.innerHTML = '';
  
    totalCycles       = 0;
    totalInstructions = Math.floor( Math.random() * 100) * 21000_0;
    for (let i = 0; i < 4; i++) {
        let pct = (Math.floor(Math.random() * 5) + 4 ) * 5;
        if (pct > remainingPct) pct = remainingPct;
        if (i == 3)
        pct = remainingPct;
        remainingPct -= pct;
        pctOfCycles[i] = pct;

        typeCPI[i]         = (pct) ? Math.floor( Math.random() * i * 2.5) + 1 : 0;
        numInstructions[i] = (typeCPI[i] != 0) ? totalInstructions * pctOfCycles[i] / 100 : 0;
        numCycles[i]       = numInstructions[i] * typeCPI[i];

        WeightedCPI          += pctOfCycles[i] * typeCPI[i];
        totalCycles       += numCycles[i];
    }

    for (let i = 0; i < 4; i++) {
        //  ${numCycles[i].toLocaleString('en-US')}
        instr.innerHTML += `<tr>
            <td id='InstrType${i}' class='instr'>${types[i]}</td>
            <td id='NumInstr${i}'  class='given'>${numInstructions[i].toLocaleString('en-US')}</td>
            <td id='InstrCPI${i}'  class='given'>${typeCPI[i]}</td>
            <td>
            <input id='NumCycles${i}'  value='' class='medium'>
            <input id='NumCycles${i}A' value=${numCycles[i].toLocaleString('en-US')} type='hidden'>
            </td>
            <td>
            <input value=''                id='pctCycles${i}'  class='small'>
            <input value=${pctOfCycles[i]} id='pctCycles${i}A' type='hidden' >
            %
            </td>
            <td>
            <input value='' id='PartialCPI${i}' class='small'>
            <input value=${(pctOfCycles[i]*typeCPI[i]/100).toFixed(2)} id='PartialCPI${i}A' type='hidden'>
            </td>
        </tr>`;
    }
  
    totCPI.innerText    = '';
    totCycles.value     = ''; // totalCycles.toLocaleString('en-US');
    totCyclesA.value    = totalCycles.toLocaleString('en-US');
    totInst.innerText   = totalInstructions.toLocaleString('en-US');
    wtdCPI.value        = ''; //  (WeightedCPI/100).toFixed(2);
    wtdCPIA.value       = (WeightedCPI/100).toFixed(2);
    runTime.innerText   = CPUTime;
    removeErrors(totCycles);
    removeErrors(wtdCPI);
    removeErrors(cps);
    removeErrors(spc);
    // cps.innerText = (+(totalCycles / CPUTime).toFixed(0)).toLocaleString('en-US');
    cps.value  = '';
    cpsA.value = toEngineering(+(totalCycles / CPUTime)/1_000_000_000);
    spc.value  = '';
    spcA.value = toEngineering((CPUTime / totalCycles)*1_000_000_000);

    //-----------------------------------------------
    let fltPt   = getBinRand();
    let binData = decToBin(fltPt);
    dec.value   = fltPt;

    fpA.value      = binData.binary
    fracA.value    = binData.binFraction;
    expDec.value   = binData.exponent;
    expA.value     = binData.binExponent;
    binaryA.value  = binData.binary;
    hexA.value     = bin2hex(binData.binary);
  
    fp.value      = '';
    frac.value    = '';
    exp.value     = '';
    binary.value  = '';
    hex.value     = '';
  
    fpA.value      = fltPt.toString(2);

    removeErrors(dec);
    removeErrors(fp);
    removeErrors(frac);
    removeErrors(exp);
    removeErrors(binary);
    removeErrors(hex);

    if (revealOn.checked)   reveal();
}

function removeErrors(el) {
    el.classList.remove('error');
    el.classList.remove('lenError');
  }

function bin2hex(b) {
    return b.match(/.{4}/g).reduce((acc, i) => {
        return acc + parseInt(i, 2).toString(16);
    }, '').toUpperCase();
}
function getBinRand() {
    let number = 0;
    let start = -6, end = 9;
    if (Math.random() < 0.15)       start = 0;
    else if (Math.random() < 0.15)  end = 0;
    while (number ===  0) {
        for (let i = start; i <= end; i++) {
            number += Math.random() < 0.33 ? Math.pow(2, i) : 0;
        }
    }
    return number * (Math.random() < 0.1 ? -1 : 1);
}

function toEngineering(num) {
  if      (num > 1)                 return num.toFixed(2);
  else if (num * 1000 > 1)          return (num*1000).toFixed(2);
  else if (num * 1000000 > 1)       return (num*1000000).toFixed(2)+'e-3';
  else if (num * 1000000000 > 1)    return (num*1000000000).toFixed(2)+'e-6';
  else if (num * 1000000000000 > 1) return (num*1000000000000).toFixed(2)+'e-9';
}

function decToBin(decNum) {
  let buffer = new ArrayBuffer(4);
  let floatView = new Float32Array(buffer);
  floatView[0] = decNum;

  let uintView = new Uint32Array(buffer);
  let binary = uintView[0].toString(2);
  binary = binary.padStart(32, '0');

  let sign = binary.charAt(0) === '1' ? '-' : '+';
  let binSign = binary.substring(0, 1);
  let binExponent = binary.substring(1, 9);
  let exponent = parseInt(binExponent, 2) - 127;
  let binFraction = binary.substring(9);
  let fraction = parseInt(binFraction, 2) / Math.pow(2, 23);

  return {
    sign: sign,
    exponent: exponent,
    fraction: fraction,
    binary: binary,
    binSign: binSign,
    binExponent: binExponent,
    binFraction:  binFraction
  };
}
</script>
</html>